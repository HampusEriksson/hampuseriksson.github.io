<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>SQL-editor med autocomplete & SQLite (mondial)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ace Editor + autocomplete -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ext-language_tools.min.js"></script>

  <!-- sql.js (SQLite i browsern) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 0.5rem 0.9rem;
      border-bottom: 1px solid #1e293b;
      background: #020617;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    header h1 {
      font-size: 1rem;
      margin: 0;
      margin-right: auto;
      font-weight: 600;
    }
    header .meta {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .toolbar {
      padding: 0.2rem 0.9rem 0.4rem 0.9rem;
      border-bottom: 1px solid #1e293b;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      background: #020617;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .tab-btn {
      padding: 0.2rem 0.6rem;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #0f172a;
      border-color: #38bdf8;
    }
    button {
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e5e7eb;
      cursor: pointer;
    }
    button:hover { background: #1e293b; }
    .toolbar-right {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .main {
      flex: 1;
      display: flex;
      min-height: 0;
    }
    #editorPane {
      flex: 0 0 60%;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    #editor {
      flex: 1;
      width: 100%;
    }
    #divider {
      width: 4px;
      cursor: col-resize;
      background: #1e293b;
    }
    #divider:hover {
      background: #38bdf8;
    }
    .right {
      flex: 0 0 40%;
      min-width: 200px;
      border-left: 1px solid #1e293b;
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }
    .right h2 {
      font-size: 0.85rem;
      margin: 0;
      padding: 0.4rem 0.7rem;
      border-bottom: 1px solid #1e293b;
      background: #020617;
    }
    #results {
      flex: 1;
      overflow: auto;
      padding: 0.4rem 0.7rem;
      font-size: 0.8rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 0.2rem 0.3rem;
      text-align: left;
    }
    th {
      background: #111827;
      position: sticky;
      top: 0;
    }
    .hint {
      padding: 0.3rem 0.9rem;
      font-size: 0.75rem;
      border-top: 1px solid #1e293b;
      background: #020617;
      color: #9ca3af;
    }
    .hint code {
      background: #0b1120;
      padding: 0.1rem 0.25rem;
      border-radius: 3px;
    }

    @media (max-width: 900px) {
      .main {
        flex-direction: column;
      }
      #divider {
        display: none;
      }
      #editorPane, .right {
        flex: 0 0 auto;
        width: 100%;
        min-height: 40%;
      }
      .right {
        border-left: none;
        border-top: 1px solid #1e293b;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>SQL-editor (mondial)</h1>
    <div class="meta">Databasen <code>mondial.db</code> laddas automatiskt.</div>
  </header>

  <div class="toolbar">
    <div class="tabs">
      <button class="tab-btn active" data-tab="0">Query 1</button>
      <button class="tab-btn" data-tab="1">Query 2</button>
      <button class="tab-btn" data-tab="2">Query 3</button>
      <button class="tab-btn" data-tab="3">Query 4</button>
      <button class="tab-btn" data-tab="4">Query 5</button>
    </div>
    <div class="toolbar-right">
      <button id="runBtn">Kör fråga</button>
      <div class="status" id="statusText">Laddar SQLite...</div>
    </div>
  </div>

  <div class="main">
    <div id="editorPane">
      <div id="editor">-- Databasen mondial.db är förladdad.
-- Exempel:
-- SELECT * FROM City LIMIT 10;
-- SELECT Country.name, COUNT(*) 
-- FROM City JOIN Country ON City.country = Country.code 
-- GROUP BY Country.name;
</div>
    </div>
    <div id="divider" title="Dra för att ändra storlek"></div>
    <div class="right">
      <h2>Resultat</h2>
      <div id="results">Ingen fråga körd ännu.</div>
    </div>
  </div>

  <div class="hint">
    <strong>Tangentbord:</strong>
    <ul style="margin:0.2rem 0 0; padding-left:1.1rem;">
      <li><code>Shift + Enter</code> – kör query i aktuell flik</li>
      <li><code>Ctrl + Space</code> – visa autocomplete</li>
    </ul>
  </div>

  <script>
    let editor, SQL, db;

    const statusEl = document.getElementById("statusText");
    const resultsEl = document.getElementById("results");
    const runBtn = document.getElementById("runBtn");
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // ----- ACE -----
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/sql");
    editor.setOptions({
      fontSize: "14px",
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      enableSnippets: false,
      showPrintMargin: false,
      wrap: true
    });
    ace.require("ace/ext/language_tools");

    // SHIFT + Enter = kör query
    editor.commands.addCommand({
      name: "runQueryShiftEnter",
      bindKey: { win: "Shift-Enter", mac: "Shift-Enter" },
      exec: function(editorInstance) {
        runBtn.click();
      }
    });

    // ----- Flik-logik -----
    const initialSql = editor.getValue();
    let tabs = [
      initialSql, // Query 1
      "",         // Query 2
      "",         // Query 3
      "",         // Query 4
      ""          // Query 5
    ];
    let activeTab = 0;

    function updateTabUi() {
      tabButtons.forEach(btn => {
        const idx = Number(btn.dataset.tab);
        if (idx === activeTab) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function switchTab(newIndex) {
      if (newIndex === activeTab) return;
      // Spara nuvarande innehåll i nuvarande flik
      tabs[activeTab] = editor.getValue();
      activeTab = newIndex;
      const content = tabs[activeTab] || "";
      editor.setValue(content, -1); // -1 = behåll caret högst upp utan undo-steg
      updateTabUi();
      setStatus(`Aktiv flik: Query ${activeTab + 1}`);
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.dataset.tab);
        switchTab(idx);
      });
    });

    updateTabUi();

    // ----- Autocomplete -----
    const baseWords = [
      { value: "SELECT", meta: "keyword" },
      { value: "FROM", meta: "keyword" },
      { value: "WHERE", meta: "keyword" },
      { value: "GROUP BY", meta: "keyword" },
      { value: "ORDER BY", meta: "keyword" },
      { value: "INNER JOIN", meta: "keyword" },
      { value: "LEFT JOIN", meta: "keyword" },
      { value: "RIGHT JOIN", meta: "keyword" },
      { value: "ON", meta: "keyword" },
      { value: "LIMIT", meta: "keyword" },
      { value: "COUNT", meta: "func" },
      { value: "AVG", meta: "func" },
      { value: "MAX", meta: "func" },
      { value: "MIN", meta: "func" },
      { value: "SUM", meta: "func" }
    ];

    let schemaWords = [...baseWords];

    const customCompleter = {
      getCompletions: function(editor, session, pos, prefix, callback) {
        if (!prefix) return callback(null, []);
        const completions = schemaWords.map(w => ({
          caption: w.value,
          value: w.value,
          meta: w.meta,
          score: 1000
        }));
        callback(null, completions);
      }
    };
    editor.completers = [customCompleter];

    function clearResults() {
      resultsEl.textContent = "Ingen fråga körd ännu.";
    }

    function renderResultSet(res) {
      if (!res || !res.length) {
        resultsEl.textContent = "Frågan gav inga rader.";
        return;
      }

      const r = res[0];
      const cols = r.columns;
      const rows = r.values;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      const trHead = document.createElement("tr");
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      resultsEl.innerHTML = "";
      resultsEl.appendChild(table);
    }

    function updateSchemaFromDb() {
      const words = [...baseWords];
      try {
        const tablesRes = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");
        if (tablesRes.length) {
          const tableNames = tablesRes[0].values.map(row => row[0]);
          tableNames.forEach(tname => {
            const t = String(tname);
            words.push({ value: t, meta: "table" });
            const info = db.exec(`PRAGMA table_info('${t.replace(/'/g, "''")}')`);
            if (info.length) {
              info[0].values.forEach(colRow => {
                const colName = String(colRow[1]);
                words.push({ value: colName, meta: `${t}.${colName}` });
              });
            }
          });
        }
      } catch (e) {
        console.warn("Kunde inte läsa schema:", e);
      }
      schemaWords = words;
    }

    function loadDbFromBuffer(buffer) {
      if (db) db.close();
      db = new SQL.Database(new Uint8Array(buffer));
      setStatus("Databas mondial.db laddad.");
      clearResults();
      updateSchemaFromDb();
    }

    async function loadMondial() {
      setStatus("Laddar mondial.db...");
      try {
        const resp = await fetch("mondial.db");
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const buf = await resp.arrayBuffer();
        loadDbFromBuffer(buf);
      } catch (e) {
        console.error(e);
        setStatus("Fel: mondial.db kunde inte laddas.");
      }
    }

    // Init sql.js
    initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
    }).then(SQLLib => {
      SQL = SQLLib;
      setStatus("SQLite redo, laddar mondial...");
      loadMondial();
    }).catch(err => {
      console.error(err);
      setStatus("Kunde inte ladda SQLite-motorn.");
    });

    runBtn.addEventListener("click", () => {
      if (!db) {
        setStatus("Databas ej laddad.");
        return;
      }
      const sql = editor.getValue().trim();
      if (!sql) {
        setStatus("Ingen SQL att köra.");
        return;
      }
      try {
        const res = db.exec(sql);
        renderResultSet(res);
        setStatus(`Fråga körd (Query ${activeTab + 1}).`);
      } catch (e) {
        resultsEl.textContent = "Fel: " + e.message;
        setStatus("Fel i SQL.");
      }
    });

    // ----- Dragbar splitter -----
    const mainEl = document.querySelector(".main");
    const editorPane = document.getElementById("editorPane");
    const rightPane = document.querySelector(".right");
    const divider = document.getElementById("divider");

    let isDragging = false;

    divider.addEventListener("mousedown", (e) => {
      isDragging = true;
      document.body.style.userSelect = "none";
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const rect = mainEl.getBoundingClientRect();
      let x = e.clientX - rect.left;
      const min = rect.width * 0.15;
      const max = rect.width * 0.85;
      if (x < min) x = min;
      if (x > max) x = max;

      const editorPct = (x / rect.width) * 100;
      const rightPct = 100 - editorPct;

      editorPane.style.flex = `0 0 ${editorPct}%`;
      rightPane.style.flex = `0 0 ${rightPct}%`;
    });

    window.addEventListener("mouseup", () => {
      if (!isDragging) return;
      isDragging = false;
      document.body.style.userSelect = "";
    });
  </script>
</body>
</html>
